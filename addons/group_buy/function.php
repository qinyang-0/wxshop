<?php/** * 页面回调函数 */function suc($data= []){	echo json_encode(['code'=>empty($data['code']) ? 0 : $data['code'],'msg'=>empty($data['msg']) ? 0 : $data['msg'],'data'=>$data],JSON_UNESCAPED_UNICODE);	exit;	}/** * 页面参数显示 */function e($data){	echo '<pre>';	print_r($data);	exit;}function recharge_indexlock($weid){	$info = pdo_fetchall(" select * from ".tablename('gpb_recharge_log')." where openid = ''");	if($info){		foreach($info as $k=>$v){			pdo_delete('gpb_recharge_log',array('id'=>$v['id']));		}	}	$list = pdo_fetchall(' select l.*,log.create_time from '.tablename('gpb_recharge_list')." l left join ".tablename('gpb_recharge_log')." log on l.time = log.create_time and l.openid = log.openid and l.id = log.uid where l.status = 1 GROUP BY l.id ");//加释放金//	echo '<pre>';print_r($list);exit;	if($list){		$rebates = config('markrting_rebates',$weid);		$rebates = $rebates ? $rebates : '释放'; 		foreach($list as $k=>$v){			if(empty($v['create_time'])){				//判断返利多少钱				$recharge = pdo_get("gpb_recharge",array('id'=>$v['recharge_id']));				pdo_insert('gpb_recharge_log',array('openid'=>$v['openid'],'info'=>'每天'.$rebates.$recharge['release_money']."元",'type'=>2,'status'=>1,'create_time'=>$v['time'],'weid'=>$weid,'money'=>$recharge['release_money'],'l_type'=>1,'st'=>1,'pay_f'=>1,'uid'=>$v['id']));			}		}	}	//获取要过期的	$list = pdo_fetchall(' select l.*,log.create_time,log.l_type from '.tablename('gpb_recharge_list')." l left join ".tablename('gpb_recharge_log')." log on l.time = log.create_time and l.openid = log.openid where l.overdue = 1 and l.status = 1 and list_type <> 3 GROUP BY l.id ");//过期日志//	echo '<pre>';//	echo ' select l.*,log.create_time,log.l_type from '.tablename('gpb_recharge_list')." l left join ".tablename('gpb_recharge_log')." log on l.time = log.create_time and l.openid = log.openid where l.overdue = 1 and l.status =1 GROUP BY l.id ";//	print_r($list);//	exit;	if($list){		$rebates = config('markrting_rebates',$weid);		$rebates = $rebates ? $rebates : '释放'; 		foreach($list as $k=>$v){			if($v['l_type'] == 1 && time()-86400 > $v['time']){				//判断返利多少钱				pdo_update("gpb_recharge_list",array('list_type'=>3),array('id'=>$v['id']));				$recharge = pdo_get("gpb_recharge",array('id'=>$v['recharge_id']));				pdo_insert('gpb_recharge_log',array('openid'=>$v['openid'],'info'=>$rebates.$recharge['release_money']."元,过期扣除",'type'=>2,'status'=>1,'create_time'=>$v['time'],'weid'=>$weid,'money'=>$recharge['release_money'],'l_type'=>2,'st'=>1,'pay_f'=>1,'uid'=>$v['id']));			}		}	}	return true;}/** * 配置信息 */function config($name='',$weid){	if(empty($name)){		return FALSE;	}	$config = pdo_get("gpb_config",array('key'=>$name,'weid'=>$weid,'status'=>1));	if(empty($config)){		return FALSE;	}	$data = $config['value'];	if(serialize(unserialize($data)) == $data){		//是序列化过了的		return unserialize($data);	}else{		//没有序列化		return $data;	}}//存取缓存function setcache($name,$value='',$time=3600){    if(!is_dir(IA_ROOT."/addons/group_buy/cache")){        mkdir(iconv("UTF-8", "GBK", IA_ROOT."/addons/group_buy/cache"),0777,true);    }    $name = md5($name);    if(empty($value)){        //获取        if(!file_exists(IA_ROOT."/addons/group_buy/cache/".$name.".txt")){            return [];        }        $txt = file_get_contents(IA_ROOT."/addons/group_buy/cache/".$name.".txt");//        var_dump($txt);        $info = unserialize($txt);//        exit(var_dump($info));        //是否过期        if(!empty($info['time']) && intval($info['time'])<time() && $info['time']!=0 ){            $info = [];            @unlink(IA_ROOT."/addons/group_buy/cache/".$name.".txt");        }elseif(!empty($info['time']) && (intval($info['time'])>=time() || $info['time']==0)){            unset($info['time']);        }        return $info;    }    //保存    if(is_array($value)){        $value['time'] = time()+$time;        $txt = serialize($value);    }else{        $txt = serialize($value);    }//    var_dump($txt);    $file = fopen(IA_ROOT."/addons/group_buy/cache/".$name.".txt","w+");    fwrite($file,$txt);    fclose($file);    if(file_exists(IA_ROOT."/addons/group_buy/cache/".$name.".txt")){        return true;    }else{        return false;    }}//删除缓存function delcache($name){    $name = md5($name);    $name = IA_ROOT."/addons/group_buy/cache/".$name.".txt";    @unlink($name);    if(file_exists(IA_ROOT."/addons/group_buy/cache/".$name.".txt")){        return false;    }else{        return true;    }}/** * 判断商品是否参与了活动 * @param $id int 商品id * @param $type int 当前活动1.秒杀 2.拼团 3.砍价 * @param $weid int 当前模块uniacid * return 成功返回 bool  失败返回  string */function goods_activity($id=0,$type=1,$weid=1){	if(empty($id)){		return '参数错误';	}	$time = time();//当前时间	//最开始的优先权是秒杀 ，其次是拼团，最后是砍价	if(file_exists('../addons/group_buy_plugin_seckill/hook.php') && $type != 1){		//文件存在  代表安装了秒杀的//		秒杀中   不管商品是否显示还是没有显示  只要存在在秒杀里面  就一律视为参与秒杀		$res = pdo_fetch("select id from ".tablename('gpb_shop_seckill_task_goods')." where uniacid = :uniacid and goodsid = :id ",array(':uniacid'=>$weid,':id'=>$id));		if($res){			return '该商品已参加秒杀!';		}	}	//拼团	if(file_exists('../addons/group_buy_plugin_team/hook.php') && $type != 2){		//文件存在  代表安装了拼团的		//判断数据库里面找到这个产品存不存在		$res = pdo_fetch("select id from ".tablename('gpb_pteam_list')." where gid = :id and weid = :weid and star_time <= :time and end_time >= :time ",array(":id"=>$id,":weid"=>$weid,":time"=>$time));		if($res){			return '该商品已参加拼团!';		}	}	//砍价	if(file_exists('../addons/group_buy_plugin_bargain/hook.php') && $type != 3){		//判断数据库里面找到这个产品存不存在		$res = pdo_fetch("select id from ".tablename('gpb_bargaion_goods')." where g_id = :id and weid = :weid and status_time <= :time and end_time >= :time ",array(':id'=>$id,':weid'=>$weid,':time'=>$time));		if($res){			return '该商品已参加砍价!';		}	}	return true;}//快速排序function quick_sort($list,$name,$deep=1){    $len = count($list);    if($len<=1){        return $list;    }    $first = array_shift($list);    $left = array();    $right = array();    foreach ($list as $k=>$v){        if($first[$name]>$v[$name]){            $right[] = $v;        }else{            $left[] = $v;        }    }    $left = quick_sort($left,$name,$deep+1);    $right = quick_sort($right,$name,$deep+1);    $list = array_merge($left, array($first), $right);    return $list;}/** * 扣除团长佣金 * @param $osn string 订单号 * @param $ossid int 快照表id */function deccommission($osn,$ossid=0){    global $_W,$_GPC;    $weid = $_W['uniacid'];    //获取订单团长    $order = pdo_fetch("select * from ".tablename("gpb_order")." where weid={$weid} and go_code='{$osn}'");    $head = $order['go_team_openid'];    if(empty($ossid) || intval($ossid)<1){        //全部扣除        //step1 佣金是否不为0        $money = doubleval($order['go_commission']);        if($money>0){        }        //配送费是否不为0        $send_money = doubleval($order['go_send_pay']);        if($send_money>0){        }    }else{        //只扣除部分    }}function hextostr($hex){    return preg_replace_callback('/\\\x([0-9a-fA-F]{2})/', function($matches) {        return chr(hexdec($matches[1]));    }, $hex);}?>